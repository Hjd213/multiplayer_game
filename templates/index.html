<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº”å­æ£‹å¯¹æˆ˜</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <h1>ğŸ¯ äº”å­æ£‹å¯¹æˆ˜å¹³å°</h1>
            <div class="room-info">
                <span>æˆ¿é—´å·: {{ room_id }}</span>
                <button class="btn btn-secondary" onclick="leaveRoom()">ç¦»å¼€æˆ¿é—´</button>
            </div>
        </div>
        
        <div class="game-content">
            <!-- å·¦ä¾§é¢æ¿ -->
            <div class="left-panel">
                <!-- ç©å®¶ä¿¡æ¯é¢æ¿ -->
                <div class="players-panel">
                    <div class="player-info" id="player1">
                        <div class="player-avatar black-stone"></div>
                        <div class="player-details">
                            <h3 id="player1-name">ç­‰å¾…ç©å®¶...</h3>
                            <div class="player-status" id="player1-status">æœªå‡†å¤‡</div>
                        </div>
                    </div>
                    
                    <div class="vs-divider">VS</div>
                    
                    <div class="player-info" id="player2">
                        <div class="player-avatar white-stone"></div>
                        <div class="player-details">
                            <h3 id="player2-name">ç­‰å¾…ç©å®¶...</h3>
                            <div class="player-status" id="player2-status">æœªå‡†å¤‡</div>
                        </div>
                    </div>
                </div>
                
                <!-- æ¸¸æˆçŠ¶æ€ä¿¡æ¯ -->
                <div class="game-status">
                    <div class="status-item">
                        <span class="status-label">å½“å‰å›åˆ:</span>
                        <span class="status-value" id="current-player">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">æ¸¸æˆçŠ¶æ€:</span>
                        <span class="status-value" id="game-status">ç­‰å¾…å¼€å§‹</span>
                    </div>
                </div>
            </div>
            
            <!-- ä¸­å¤®æ£‹ç›˜åŒºåŸŸ -->
            <div class="center-panel">
                <div class="board-container">
                    <div class="board" id="game-board">
                        <div class="board-grid"></div>
                        <!-- æ£‹å­å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§é¢æ¿ -->
            <div class="right-panel">
                <!-- æ¸¸æˆæ§åˆ¶é¢æ¿ -->
                <div class="controls-panel">
                    <button class="btn btn-primary" id="restart-btn" onclick="restartGame()" disabled>é‡æ–°å¼€å§‹</button>
                    <button class="btn btn-warning" onclick="showRules()">æ¸¸æˆè§„åˆ™</button>
                </div>
                
                <!-- æœ€è¿‘æ­¥éª¤æ˜¾ç¤º -->
                <div class="recent-moves">
                    <h3>æœ€è¿‘æ­¥éª¤</h3>
                    <div id="moves-list">
                        <p>æ¸¸æˆå°šæœªå¼€å§‹</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- è·èƒœå¼¹çª— -->
    <div class="modal" id="win-modal" style="display: none;">
        <div class="modal-content">
            <h2 id="win-message">æ¸¸æˆç»“æŸ</h2>
            <button class="btn btn-primary" onclick="closeWinModal()">ç¡®å®š</button>
        </div>
    </div>
    
    <!-- è§„åˆ™å¼¹çª— -->
    <div class="modal" id="rules-modal" style="display: none;">
        <div class="modal-content">
            <h2>æ¸¸æˆè§„åˆ™</h2>
            <div class="rules-content">
                <p><strong>ç›®æ ‡ï¼š</strong>åœ¨15Ã—15çš„æ£‹ç›˜ä¸Šï¼Œç‡å…ˆè¿æˆäº”å­ï¼ˆæ¨ªã€ç«–ã€æ–œï¼‰çš„ä¸€æ–¹è·èƒœã€‚</p>
                <p><strong>è§„åˆ™ï¼š</strong></p>
                <ul>
                    <li>é»‘å­å…ˆè¡Œ</li>
                    <li>è½®æµä¸‹æ£‹ï¼Œæ¯æ¬¡åªèƒ½ä¸‹ä¸€æšæ£‹å­</li>
                    <li>æ£‹å­ä¸‹åœ¨äº¤å‰ç‚¹ä¸Š</li>
                    <li>æœ€å…ˆè¿æˆäº”ä¸ªåŒè‰²æ£‹å­è€…è·èƒœ</li>
                    <li>å¯ä»¥æ¨ªã€ç«–ã€æ–œè¿æˆäº”å­</li>
                </ul>
            </div>
            <button class="btn btn-primary" onclick="closeRulesModal()">å…³é—­</button>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        const roomId = "{{ room_id }}";
        let gameState = null;
        let myPlayerId = null;
        let myColor = null;
        let gameInterval = null;
        let boardElement = null;
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            boardElement = document.getElementById('game-board');
            initializeBoard();
            startGameStatePolling();
        });
        
        // åˆå§‹åŒ–æ£‹ç›˜ - åˆ›å»ºç‚¹å‡»åŒºåŸŸå’Œç½‘æ ¼ï¼ˆä½¿ç”¨å›ºå®š36pxç½‘æ ¼ï¼‰
        function initializeBoard() {
            const board = boardElement;
            board.innerHTML = '<div class="board-grid"></div>';
            
            // å›ºå®šç½‘æ ¼å°ºå¯¸ï¼š15Ã—15ï¼Œæ¯æ ¼36px
            const cellSize = 36;
            const boardGrid = board.querySelector('.board-grid');
            
            // åˆ›å»ºç½‘æ ¼çº¿ - 16æ¡å‚ç›´çº¿ and 16æ¡æ°´å¹³çº¿ (15æ ¼éœ€è¦16æ¡çº¿)
            for (let i = 0; i <= 15; i++) {
                // å‚ç›´ç½‘æ ¼çº¿
                const verticalLine = document.createElement('div');
                verticalLine.className = 'vertical-line';
                verticalLine.style.left = `${i * cellSize}px`;
                verticalLine.style.top = '0';
                verticalLine.style.height = '100%';
                boardGrid.appendChild(verticalLine);
                
                // æ°´å¹³ç½‘æ ¼çº¿
                const horizontalLine = document.createElement('div');
                horizontalLine.className = 'horizontal-line';
                horizontalLine.style.top = `${i * cellSize}px`;
                horizontalLine.style.left = '0';
                horizontalLine.style.width = '100%';
                boardGrid.appendChild(horizontalLine);
            }
            
            // åˆ›å»º15x15çš„ç‚¹å‡»åŒºåŸŸ - ç²¾ç¡®å¯¹åº”äº¤å‰ç‚¹
            for (let row = 0; row < 15; row++) {
                for (let col = 0; col < 15; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'board-cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    
                    // è®¡ç®—äº¤å‰ç‚¹çš„ç²¾ç¡®ä½ç½®ï¼ˆä»æ£‹ç›˜å·¦ä¸Šè§’å¼€å§‹ï¼Œè¾¹è·18pxï¼‰
                    const left = 18 + (col * cellSize);
                    const top = 18 + (row * cellSize);
                    
                    cell.style.left = `${left}px`;
                    cell.style.top = `${top}px`;
                    cell.addEventListener('click', () => makeMove(row, col));
                    board.appendChild(cell);
                }
            }
        }
        
        // ä¸‹æ£‹
        async function makeMove(row, col) {
            if (!gameState || gameState.game_status !== 'playing') {
                showMessage('æ¸¸æˆå°šæœªå¼€å§‹æˆ–å·²ç»“æŸ');
                return;
            }
            
            try {
                const response = await fetch(`/api/make_move/${roomId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ row: row, col: col })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updateGameState(data.game_state);
                    showMessage(data.message);
                } else {
                    showMessage(data.message || 'ä¸‹æ£‹å¤±è´¥');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }
        
        // å¼€å§‹è½®è¯¢æ¸¸æˆçŠ¶æ€
        function startGameStatePolling() {
            gameInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/game_state/${roomId}`);
                    const data = await response.json();
                    
                    if (response.ok) {
                        updateGameState(data);
                    }
                } catch (error) {
                    console.error('Failed to fetch game state:', error);
                }
            }, 1000); // æ¯ç§’æ›´æ–°ä¸€æ¬¡
        }
        
        // æ›´æ–°æ¸¸æˆçŠ¶æ€æ˜¾ç¤º
        function updateGameState(state) {
            gameState = state;
            
            // æ›´æ–°æ£‹ç›˜
            updateBoard(state.board);
            
            // æ›´æ–°ç©å®¶ä¿¡æ¯
            updatePlayersInfo(state.players);
            
            // æ›´æ–°æ¸¸æˆçŠ¶æ€
            document.getElementById('game-status').textContent = 
                state.game_status === 'waiting' ? 'ç­‰å¾…ç©å®¶' :
                state.game_status === 'playing' ? 'è¿›è¡Œä¸­' : 'å·²ç»“æŸ';
            
            // æ›´æ–°å½“å‰ç©å®¶
            const currentPlayer = state.current_player === 1 ? 'é»‘å­' : 'ç™½å­';
            document.getElementById('current-player').textContent = currentPlayer;
            
            // æ›´æ–°æœ€è¿‘æ­¥éª¤
            updateRecentMoves(state.move_history);
            
            // æ£€æŸ¥æ¸¸æˆç»“æœ
            if (state.game_status === 'finished') {
                showWinner(state.winner);
                document.getElementById('restart-btn').disabled = false;
            }
        }
        
        // æ›´æ–°æ£‹ç›˜æ˜¾ç¤º
        function updateBoard(board) {
            const boardElement = document.getElementById('game-board');
            
            // ç§»é™¤æ‰€æœ‰ç°æœ‰æ£‹å­
            const existingStones = boardElement.querySelectorAll('.stone');
            existingStones.forEach(stone => stone.remove());
            
            // å›ºå®šç½‘æ ¼å°ºå¯¸ï¼š15Ã—15ï¼Œæ¯æ ¼36px
            const cellSize = 36;
            
            // æ·»åŠ æ–°çš„æ£‹å­ - ç²¾ç¡®æ”¾åœ¨äº¤å‰ç‚¹ä¸Š
            for (let row = 0; row < 15; row++) {
                for (let col = 0; col < 15; col++) {
                    const value = board[row][col];
                    if (value !== 0) {
                        const stone = document.createElement('div');
                        stone.className = `stone ${value === 1 ? 'black' : 'white'}`;
                        
                        // è®¡ç®—äº¤å‰ç‚¹çš„ç²¾ç¡®åæ ‡ï¼ˆä»æ£‹ç›˜å·¦ä¸Šè§’å¼€å§‹ï¼Œè¾¹è·18pxï¼‰
                        const left = 18 + (col * cellSize);
                        const top = 18 + (row * cellSize);
                        
                        stone.style.left = `${left}px`;
                        stone.style.top = `${top}px`;
                        
                        boardElement.appendChild(stone);
                    }
                }
            }
        }
        
        // æ›´æ–°ç©å®¶ä¿¡æ¯
        function updatePlayersInfo(players) {
            const playerEntries = Object.entries(players);
            
            // æ›´æ–°ç©å®¶1ï¼ˆé»‘å­ï¼‰
            if (playerEntries[0]) {
                const [playerId, playerData] = playerEntries[0];
                document.getElementById('player1-name').textContent = playerData.name;
                document.getElementById('player1-status').textContent = 
                    playerData.color === 1 ? 'é»‘å­' : 'ç™½å­';
                document.getElementById('player1-status').className = 
                    `player-status ${playerData.color === 1 ? 'black' : 'white'}`;
            }
            
            // æ›´æ–°ç©å®¶2ï¼ˆç™½å­ï¼‰
            if (playerEntries[1]) {
                const [playerId, playerData] = playerEntries[1];
                document.getElementById('player2-name').textContent = playerData.name;
                document.getElementById('player2-status').textContent = 
                    playerData.color === 2 ? 'ç™½å­' : 'é»‘å­';
                document.getElementById('player2-status').className = 
                    `player-status ${playerData.color === 2 ? 'white' : 'black'}`;
            }
        }
        
        // æ›´æ–°æœ€è¿‘æ­¥éª¤
        function updateRecentMoves(moves) {
            const movesList = document.getElementById('moves-list');
            
            if (moves.length === 0) {
                movesList.innerHTML = '<p>æš‚æ— æ­¥éª¤è®°å½•</p>';
                return;
            }
            
            movesList.innerHTML = moves.map(move => {
                const color = move.player === 1 ? 'é»‘å­' : 'ç™½å­';
                const time = new Date(move.timestamp).toLocaleTimeString();
                return `<div class="move-item">${color}: (${move.row+1}, ${move.col+1}) - ${time}</div>`;
            }).join('');
        }
        
        // æ˜¾ç¤ºè·èƒœä¿¡æ¯
        function showWinner(winner) {
            const winnerText = winner === 1 ? 'ğŸ‰ é»‘å­è·èƒœï¼' : 'ğŸ‰ ç™½å­è·èƒœï¼';
            document.getElementById('win-message').textContent = winnerText;
            document.getElementById('win-modal').style.display = 'block';
        }
        
        // å…³é—­è·èƒœå¼¹çª—
        function closeWinModal() {
            document.getElementById('win-modal').style.display = 'none';
        }
        
        // æ˜¾ç¤ºæ¸¸æˆè§„åˆ™
        function showRules() {
            document.getElementById('rules-modal').style.display = 'block';
        }
        
        // å…³é—­è§„åˆ™å¼¹çª—
        function closeRulesModal() {
            document.getElementById('rules-modal').style.display = 'none';
        }
        
        // ç¦»å¼€æˆ¿é—´
        async function leaveRoom() {
            if (confirm('ç¡®å®šè¦ç¦»å¼€æˆ¿é—´å—ï¼Ÿ')) {
                try {
                    await fetch(`/api/leave_room/${roomId}`, {
                        method: 'POST'
                    });
                    clearInterval(gameInterval);
                    window.location.href = '/';
                } catch (error) {
                    console.error('Error leaving room:', error);
                }
            }
        }
        
        // é‡æ–°å¼€å§‹æ¸¸æˆ
        async function restartGame() {
            if (!gameState || gameState.game_status !== 'finished') {
                showMessage('åªæœ‰æ¸¸æˆç»“æŸåæ‰èƒ½é‡æ–°å¼€å§‹');
                return;
            }
            
            if (confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹æ¸¸æˆå—ï¼Ÿè¿™å°†æ¸…ç©ºå½“å‰æ¸¸æˆè¿›åº¦ã€‚')) {
                try {
                    // å‘é€é‡æ–°å¼€å§‹è¯·æ±‚åˆ°åç«¯
                    const response = await fetch(`/api/restart_game/${roomId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            // é‡ç½®æœ¬åœ°çŠ¶æ€
                            gameState = data.game_state;
                            updateGameState(gameState);
                            document.getElementById('restart-btn').disabled = true;
                            showMessage('æ¸¸æˆå·²é‡æ–°å¼€å§‹ï¼');
                        } else {
                            showMessage('é‡æ–°å¼€å§‹å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                        }
                    } else {
                        showMessage('é‡æ–°å¼€å§‹å¤±è´¥ï¼šæœåŠ¡å™¨é”™è¯¯');
                    }
                } catch (error) {
                    console.error('Error restarting game:', error);
                    showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
                }
            }
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message) {
            // ä½¿ç”¨æ›´å‹å¥½çš„æç¤ºæ–¹å¼
            alert(message);
        }
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', function() {
            if (gameInterval) {
                clearInterval(gameInterval);
            }
        });
        
        // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°åˆå§‹åŒ–æ£‹ç›˜
        window.addEventListener('resize', function() {
            if (boardElement) {
                // æ¸…é™¤ç°æœ‰çš„ç‚¹å‡»åŒºåŸŸ
                const cells = boardElement.querySelectorAll('.board-cell');
                cells.forEach(cell => cell.remove());
                
                // é‡æ–°åˆ›å»ºç‚¹å‡»åŒºåŸŸå’Œç½‘æ ¼çº¿
                setTimeout(() => {
                    initializeBoard();
                }, 100);
            }
        });
    </script>
</body>
</html>